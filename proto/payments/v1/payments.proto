syntax = "proto3";

package payments.v1;

option go_package = "github.com/lastviking/payments-proto/gen/go/payments/v1;paymentsv1";
option java_multiple_files = true;
option java_package = "eu.lastviking.payments.v1";

import "google/protobuf/timestamp.proto";

//
// PaymentsService: implemented by the payment backend.
// Called by other backend services over VPN (mTLS auth).
//
service PaymentsService {
  // Returns the current entitlement state for a tenant.
  rpc GetEntitlement(GetEntitlementRequest) returns (GetEntitlementResponse);

  // Batch form (useful for dashboards / backfills).
  rpc GetEntitlements(GetEntitlementsRequest) returns (GetEntitlementsResponse);

  // Initiate a new subscription flow (typically Stripe Checkout or Billing Portal).
  // For Google Play, this may return UNIMPLEMENTED or a no-op depending on your client flow.
  rpc CreateSubscriptionIntent(CreateSubscriptionIntentRequest)
      returns (CreateSubscriptionIntentResponse);

  // Optional "fast path" confirmation after user returns from Stripe.
  // Webhooks remain the durable truth; this just improves UX.
  rpc ConfirmExternalPurchase(ConfirmExternalPurchaseRequest)
      returns (ConfirmExternalPurchaseResponse);

  // Acknowledge/record a Google Play purchase token (usually sent from your app backend
  // after the mobile client completes purchase).
  rpc RegisterGooglePlayPurchase(RegisterGooglePlayPurchaseRequest)
      returns (RegisterGooglePlayPurchaseResponse);
}

message GetEntitlementRequest {
  string tenant_id = 1;
  string product_id = 2; // NextApp, nsblast ...
}

message GetEntitlementResponse {
  Entitlement entitlement = 1;
}

message GetEntitlementsRequest {
  repeated string tenant_ids = 1;
  string product_id = 2;
}

message GetEntitlementsResponse {
  repeated Entitlement entitlements = 1;
}

message CreateSubscriptionIntentRequest {
  string tenant_id = 1;
  string product_id = 2;
  string plan_id = 3;
  optional int32 seats = 4; // Ie, NextApp, number of users

  PaymentProvider provider = 5;

  // The backend should generate these URLs and pass them through.
  // Used for Stripe Checkout / Portal flows.
  string return_url = 6;
  string cancel_url = 7;

  // Optional: for correlation / de-duplication on caller side.
  string client_reference_id = 8;
}

message CreateSubscriptionIntentResponse {
  // URL the user should be redirected to (Stripe Checkout / Portal).
  string url = 1;

  // Provider-specific reference (e.g. Stripe checkout_session_id).
  string external_reference = 2;

  // A server-generated id for this intent (stable, unique).
  string intent_id = 3;

  google.protobuf.Timestamp created_at = 4;
}

message ConfirmExternalPurchaseRequest {
  string tenant_id = 1;
  string product_id = 2;

  PaymentProvider provider = 3;

  // E.g. Stripe checkout_session_id, or other provider handle.
  string external_reference = 4;

  // Optional: caller-generated correlation id.
  string client_reference_id = 5;
}

message ConfirmExternalPurchaseResponse {
  // Best effort: the updated entitlement if immediately resolvable.
  // If not yet resolvable, return the current entitlement.
  Entitlement entitlement = 1;

  // True if the server performed a provider lookup and updated state.
  bool updated = 2;
}

message RegisterGooglePlayPurchaseRequest {
  string tenant_id = 1;
  string product_id = 2;
  string plan_id = 3;

  // Android package name of the app making the purchase.
  string package_name = 4;

  // The purchase token from the Play Billing client.
  string purchase_token = 5;

  // Optional: product/offer identifiers if you want them for mapping/audit.
  string play_product_id = 6;
  string play_base_plan_id = 7;
  string play_offer_id = 8;

  // Optional: for de-duplication on caller side.
  string client_reference_id = 9;
}

message RegisterGooglePlayPurchaseResponse {
  Entitlement entitlement = 1;
}

enum PaymentProvider {
  PAYMENT_PROVIDER_UNSPECIFIED = 0;
  PAYMENT_PROVIDER_STRIPE = 1;
  PAYMENT_PROVIDER_GOOGLE_PLAY = 2;
}

enum EntitlementState {
  ENTITLEMENT_STATE_UNSPECIFIED = 0;

  // Service should be delivered.
  ENTITLEMENT_STATE_ACTIVE = 1;

  // Temporary issues; policy-dependent whether you deliver.
  ENTITLEMENT_STATE_GRACE = 2;
  ENTITLEMENT_STATE_PAST_DUE = 3;

  // No longer deliver.
  ENTITLEMENT_STATE_CANCELED = 4;
  ENTITLEMENT_STATE_EXPIRED = 5;

  // Administrative suspension.
  ENTITLEMENT_STATE_SUSPENDED = 6;
}

message Entitlement {
  string tenant_id = 1;
  string product_id = 2;
  string plan_id = 3;
  optional int32 seats = 10;

  EntitlementState state = 4;

  // If ACTIVE/GRACE, typically the end of the paid period.
  google.protobuf.Timestamp valid_until = 5;

  PaymentProvider source = 6;

  // Provider-specific subscription id / token hash reference.
  string source_ref = 7;

  // Monotonic version; increments on every state change for this tenant+product.
  // Use for ordering and idempotency in notifications.
  uint64 version = 8;

  google.protobuf.Timestamp updated_at = 9;
}
